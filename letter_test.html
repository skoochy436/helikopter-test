<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Harf Testi Modülü - 5 Aşama</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 20px;
    }
    #initialLetters, #querySection, #resultSection, #nextSection, #countdown, #restartBtn {
      margin-top: 20px;
    }
    button {
      font-size: 16px;
      padding: 10px 20px;
      margin: 10px;
    }
    #queryText, #initialText, #resultText, #countdownText {
      font-size: 24px;
      margin: 20px;
    }
    #stageIndicator {
      font-size: 18px;
      font-weight: bold;
      margin-top: 10px;
    }
    #startBtn, #restartBtn {
      display: block;
      margin: 20px auto;
    }
  </style>
</head>
<body>
  <h2>Harf Testi Modülü - 5 Aşama</h2>
  <button id="startBtn">Teste Başla</button>
  <button id="restartBtn" style="display: none;">Yeniden Başlat</button>
  <div id="stageIndicator"></div>

  <div id="countdown" style="display: none;">
    <div id="countdownText"></div>
  </div>

  <div id="initialLetters" style="display: none;">
    <div id="initialText"></div>
  </div>

  <div id="querySection" style="display: none;">
    <div id="queryText"></div>
    <button id="yesBtn">Evet</button>
    <button id="noBtn">Hayır</button>
  </div>

  <div id="resultSection" style="display: none;">
    <div id="resultText"></div>
  </div>

  <div id="nextSection" style="display: none;">
    <button id="nextBtn">Sonraki</button>
  </div>

  <script>
    // Aşamalar için ayarlar: initialCount ve queryCount
    const stages = [
      {initialCount: 5, queryCount: 2},
      {initialCount: 6, queryCount: 2},
      {initialCount: 7, queryCount: 2},
      {initialCount: 8, queryCount: 3},
      {initialCount: 9, queryCount: 3}
    ];
    let currentStage = 0;
    let initialLetters = [];
    let queryLetters = [];
    let countdownTime = 4;
    let countdownInterval;

    const startBtn = document.getElementById('startBtn');
    const restartBtn = document.getElementById('restartBtn');
    const stageIndicator = document.getElementById('stageIndicator');
    const initialLettersDiv = document.getElementById('initialLetters');
    const initialText = document.getElementById('initialText');
    const countdownDiv = document.getElementById('countdown');
    const countdownText = document.getElementById('countdownText');
    const querySection = document.getElementById('querySection');
    const queryText = document.getElementById('queryText');
    const yesBtn = document.getElementById('yesBtn');
    const noBtn = document.getElementById('noBtn');
    const resultSection = document.getElementById('resultSection');
    const resultText = document.getElementById('resultText');
    const nextSection = document.getElementById('nextSection');
    const nextBtn = document.getElementById('nextBtn');

    function getRandomLetter(exclude = []) {
      const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      let letter;
      do {
        letter = alphabet[Math.floor(Math.random() * alphabet.length)];
      } while (exclude.includes(letter));
      return letter;
    }

    function generateInitialLetters(count) {
      const letters = [];
      while (letters.length < count) {
        const letter = getRandomLetter(letters);
        letters.push(letter);
      }
      return letters;
    }

    function generateQueryLetters(count, initialLetters) {
      const letters = [];
      const isTrueCase = Math.random() < 0.5;
      if (isTrueCase) {
        // Pick 'count' letters from initialLetters
        const shuffled = initialLetters.slice().sort(() => Math.random() - 0.5);
        for (let i = 0; i < count; i++) {
          letters.push(shuffled[i]);
        }
      } else {
        // At least one letter not in initialLetters
        const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        let outside;
        do {
          outside = alphabet[Math.floor(Math.random() * alphabet.length)];
        } while (initialLetters.includes(outside));
        letters.push(outside);
        while (letters.length < count) {
          const pick = getRandomLetter([]);
          if (!letters.includes(pick)) {
            letters.push(pick);
          }
        }
        if (letters.every(l => initialLetters.includes(l))) {
          letters[0] = outside;
        }
      }
      return letters;
    }

    function showInitialLetters() {
      stageIndicator.textContent = `Aşama ${currentStage + 1} / ${stages.length}`;
      const initCount = stages[currentStage].initialCount;
      initialLetters = generateInitialLetters(initCount);
      initialText.textContent = `Harfler (${initCount}): ${initialLetters.join(' ')}`;
      countdownTime = 4;
      countdownText.textContent = countdownTime;
      countdownDiv.style.display = 'block';
      initialLettersDiv.style.display = 'block';
      // Başlat countdown
      countdownInterval = setInterval(() => {
        countdownTime--;
        countdownText.textContent = countdownTime;
        if (countdownTime <= 0) {
          clearInterval(countdownInterval);
          countdownDiv.style.display = 'none';
          initialLettersDiv.style.display = 'none';
          showQuery();
        }
      }, 1000);
    }

    function showQuery() {
      const queryCount = stages[currentStage].queryCount;
      queryLetters = generateQueryLetters(queryCount, initialLetters);
      queryText.textContent = `Bu harfler listede var mı? (${queryCount} harf) ${queryLetters.join(' ')}`;
      querySection.style.display = 'block';
    }

    function handleAnswer(answer) {
      const allIn = queryLetters.every(l => initialLetters.includes(l));
      const correct = answer === allIn;
      resultText.textContent = correct ? '✅ Doğru!' : `❌ Yanlış! Doğru cevap: ${allIn ? 'Evet' : 'Hayır'}`;
      resultSection.style.display = 'block';
      querySection.style.display = 'none';
      nextSection.style.display = 'block';
    }

    function nextStage() {
      resultSection.style.display = 'none';
      nextSection.style.display = 'none';
      currentStage++;
      if (currentStage < stages.length) {
        showInitialLetters();
      } else {
        stageIndicator.textContent = 'Test tamamlandı!';
        restartBtn.style.display = 'block';
      }
    }

    function startTest() {
      startBtn.style.display = 'none';
      currentStage = 0;
      stageIndicator.textContent = '';
      resultSection.style.display = 'none';
      nextSection.style.display = 'none';
      querySection.style.display = 'none';
      restartBtn.style.display = 'none';
      showInitialLetters();
    }

    function restartTest() {
      restartBtn.style.display = 'none';
      startTest();
    }

    // Olay dinleyicileri
    yesBtn.addEventListener('click', () => handleAnswer(true));
    noBtn.addEventListener('click', () => handleAnswer(false));
    nextBtn.addEventListener('click', nextStage);
    startBtn.addEventListener('click', startTest);
    restartBtn.addEventListener('click', restartTest);

    // Başlangıçta sadece start butonunu göster
    window.onload = () => {
      startBtn.style.display = 'block';
      restartBtn.style.display = 'none';
      stageIndicator.textContent = '';
      initialLettersDiv.style.display = 'none';
      countdownDiv.style.display = 'none';
      querySection.style.display = 'none';
      resultSection.style.display = 'none';
      nextSection.style.display = 'none';
    };
  </script>
</body>
</html>
